<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AIRV v8.0 – ADVANCED INTELLIGENCE REMOTE VIEWING</title>
<style>
  :root {
    --bg: #050705; --panel: #0d110d; --border: #1a2a1a;
    --green: #00ff66; --green-dim: #006622; --amber: #ffaa00;
    --red: #ff3333; --txt: #d1ffd1; --font: "Courier New", monospace;
  }
  * { box-sizing: border-box; }
  body { 
    margin: 0; background: var(--bg); color: var(--txt); 
    font: 13px/1.4 var(--font); text-transform: uppercase;
    min-height: 100vh; overflow-x: hidden;
  }
  
  .header { 
    min-height: 50px; border-bottom: 2px solid var(--border); 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 10px 15px; background: var(--panel); flex-wrap: wrap; gap: 10px;
  }
  .header-title { 
    letter-spacing: 2px; font-weight: bold; color: var(--green); 
    font-size: clamp(10px, 2.5vw, 13px);
  }
  .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  
  .main-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    min-height: calc(100vh - 70px);
  }
  
  @media (min-width: 768px) {
    .main-grid { grid-template-columns: 260px 1fr; }
  }
  
  @media (min-width: 1200px) {
    .main-grid { grid-template-columns: 280px 1fr 300px; }
  }
  
  .sidebar, .log-panel { 
    padding: 15px; display: flex; flex-direction: column; gap: 10px; 
    background: #080a08; border-bottom: 2px solid var(--border);
  }
  
  @media (min-width: 768px) {
    .sidebar { border-right: 2px solid var(--border); border-bottom: none; }
  }
  
  @media (min-width: 1200px) {
    .log-panel { 
      border-left: 2px solid var(--border); 
      border-bottom: none; display: flex !important; 
    }
  }
  
  .log-panel { display: none; }
  
  .content { 
    padding: 15px; overflow-y: auto; background: var(--bg); 
    position: relative; min-height: 400px;
  }
  
  /* Bars */
  .meter { 
    height: 12px; background: #000; border: 1px solid var(--border); 
    margin: 5px 0; position: relative; overflow: hidden;
  }
  .meter-fill { 
    height: 100%; width: 0%; background: var(--green); 
    transition: width 0.4s ease; box-shadow: 0 0 10px var(--green-dim); 
  }
  .target-line { 
    position: absolute; left: 50%; top: 0; bottom: 0; 
    border-left: 1px dashed var(--red); z-index: 5; 
  }
  
  .btn { 
    background: transparent; border: 1px solid var(--green-dim); 
    color: var(--green); padding: 12px 8px; cursor: pointer; 
    text-align: left; font-size: 11px; width: 100%; 
    text-transform: uppercase; transition: all 0.2s;
    touch-action: manipulation;
  }
  .btn:hover, .btn.active { 
    background: var(--green-dim); color: #000; font-weight: bold; 
  }
  .btn-amber { border-color: var(--amber); color: var(--amber); }
  .btn-amber:hover, .btn-amber.active { background: var(--amber); color: #000; }

  textarea, input { 
    background: #000; border: 1px solid var(--border); 
    color: var(--green); padding: 12px; 
    font: 12px var(--font); width: 100%; outline: none; 
    margin-bottom: 10px; resize: vertical; min-height: 80px;
    touch-action: manipulation;
  }
  
  select { 
    background: #000; color: var(--green); 
    border: 1px solid var(--border); padding: 5px 8px; 
    font: 11px var(--font); outline: none;
    touch-action: manipulation;
  }
  
  .matrix-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 10px; 
  }
  
  @media (min-width: 600px) {
    .matrix-grid { grid-template-columns: 1fr 1fr; }
  }
  
  .label { 
    font-size: 10px; color: var(--green-dim); 
    letter-spacing: 1px; margin-bottom: 5px; 
    display: block; 
  }
  
  .status-tag { 
    font-size: 9px; padding: 3px 6px; 
    border: 1px solid var(--green-dim); 
    color: var(--green-dim); margin-top: 5px; 
    display: inline-block; 
  }
  
  .report-frame { 
    background: #000; padding: 20px; 
    border: 2px solid var(--green-dim); 
    white-space: pre-wrap; font-size: 11px; 
    line-height: 1.6; color: #fff; 
    overflow-x: auto; word-break: break-word;
  }
  
  .info-box {
    background: rgba(0,255,100,0.03); 
    border: 1px solid var(--border); 
    padding: 10px; margin-top: 10px;
  }
  
  .progress-container {
    display: flex;
    gap: 5px;
    margin: 10px 0;
    flex-wrap: wrap;
  }
  
  .progress-step {
    flex: 1;
    min-width: 40px;
    height: 4px;
    background: #000;
    border: 1px solid var(--border);
    position: relative;
  }
  
  .progress-step.completed {
    background: var(--green);
    box-shadow: 0 0 8px var(--green-dim);
  }
  
  .hint-text {
    color: var(--amber); 
    margin-bottom: 15px; 
    font-size: 11px;
    line-height: 1.5;
    padding: 10px;
    background: rgba(255,170,0,0.05);
    border-left: 2px solid var(--amber);
  }
  
  @media (max-width: 767px) {
    body { font-size: 12px; }
    .btn { padding: 10px 6px; font-size: 10px; }
    textarea, input { font-size: 11px; padding: 10px; }
    .report-frame { padding: 15px; font-size: 10px; }
    .header-title { letter-spacing: 1px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-title">AIRV // INTELLIGENCE_PROTOCOL_v8.0</div>
  <div class="header-controls">
    <select id="lang-select" onchange="changeLanguage()">
      <option value="bg">БЪЛГАРСКИ</option>
      <option value="en">ENGLISH</option>
      <option value="de">DEUTSCH</option>
      <option value="es">ESPAÑOL</option>
      <option value="fr">FRANÇAIS</option>
      <option value="cz">ČEŠTINA</option>
    </select>
    <div id="clock" style="color:var(--amber); font-size: 11px;">00:00:00</div>
  </div>
</div>

<div class="main-grid">
  <div class="sidebar">
    <span class="label" id="txt-protocol">ПРОТОКОЛ</span>
    
    <div class="progress-container">
      <div class="progress-step" id="prog-s1"></div>
      <div class="progress-step" id="prog-s2"></div>
      <div class="progress-step" id="prog-s3"></div>
      <div class="progress-step" id="prog-s4"></div>
      <div class="progress-step" id="prog-s5"></div>
    </div>
    
    <button class="btn" id="b-s1" onclick="nav('s1')">S1: IDEOGRAM</button>
    <button class="btn" id="b-s2" onclick="nav('s2')">S2: SENSORY</button>
    <button class="btn" id="b-s3" onclick="nav('s3')">S3: SKETCH</button>
    <button class="btn" id="b-s4" onclick="nav('s4')">S4: MATRIX</button>
    <button class="btn" id="b-s5" onclick="nav('s5')">S5: SUMMARY</button>
    
    <div class="info-box">
      <span class="label" id="txt-signal">СИЛА НА СИГНАЛ</span>
      <div class="meter"><div class="target-line"></div><div id="sig-fill" class="meter-fill"></div></div>
      <span class="label" id="txt-noise">АНАЛИТИЧЕН ШУМ (AOL)</span>
      <div class="meter"><div id="aol-fill" class="meter-fill" style="background:var(--amber)"></div></div>
      <div id="profile-match" style="margin-top:10px; color:var(--green); font-size:10px; font-weight:bold;">DATA: WAITING...</div>
      <div class="status-tag" id="txt-min-req">МИН: >50% ЗА ВАЛИДНОСТ</div>
    </div>

    <div style="margin-top: auto;">
      <span class="label" id="txt-coords">КООРДИНАТИ</span>
      <div id="trn-display" style="font-size: 16px; color: var(--amber); margin-bottom: 10px; word-break: break-all;">----/----</div>
      <button class="btn btn-amber" onclick="initNewSession()" id="txt-new-btn">НОВА СЕСИЯ</button>
      <button class="btn" onclick="nav('rep')" style="margin-top:10px; border-color:var(--green);" id="txt-rep-btn">ФИНАЛИЗИРАЙ</button>
      <button class="btn" onclick="toggleLog()" style="margin-top:5px; border-color:var(--amber); display: none;" id="txt-log-btn">LOG</button>
    </div>
  </div>

  <main class="content" id="workspace">
    <div style="text-align:center; margin-top:60px; color:var(--green-dim); padding: 20px;">
      <div style="font-size: 14px; margin-bottom: 20px;">SELECT PROTOCOL TO BEGIN</div>
      <div style="font-size: 10px; line-height: 1.6;">
        AIRV (ADVANCED INTELLIGENCE REMOTE VIEWING)<br/>
        CLASSIFIED ANALYTIC FRAMEWORK<br/>
        <span style="color: var(--amber);">TAP "НОВА СЕСИЯ" TO INITIALIZE</span>
      </div>
    </div>
  </main>

  <div class="log-panel" id="log-panel">
    <span class="label" id="txt-log">LIVE LOG</span>
    <div id="log-content" style="flex-grow:1; overflow-y:auto; font-size:10px; color:var(--green-dim); border: 1px solid #111; padding: 5px;"></div>
  </div>
</div>

<script>
// --- MULTILINGUAL DATA ---
const UI_TEXT = {
  bg: {
    protocol: "ПРОТОКОЛ", signal: "СИЛА НА СИГНАЛ", noise: "АНАЛИТИЧЕН ШУМ", 
    minreq: "МИН: >50% ЗА ВАЛИДНОСТ", coords: "КООРДИНАТИ", 
    newbtn: "НОВА СЕСИЯ", repbtn: "ФИНАЛИЗИРАЙ", log: "ЛОГ НА ЖИВО", logbtn: "ЛОГ",
    hints: {
      s1: "Етап 1: IDEOGRAM – Начертай импулса веднага. Опиши физически гещалт без анализ (твърдо/меко, енергия, течност, органично/изкуствено).",
      s2: "Етап 2: SENSORY – Сетивни качества (цветове, звуци, мирозми, текстури, температура). БЕЗ ИМЕНА! Само сензорни данни.",
      s3: "Етап 3: SKETCH – Скица на обекта. Рисувай инстинктивно. Избягвай сложни детайли. Просто форма и пространство.",
      s4: "Етап 4: MATRIX – Раздели данните: Сетивни (S), Размери (D), Аналитичен шум (AOL). Изолирай чистия сигнал.",
      s5: "Етап 5: SUMMARY – Обобщение. Каква е функцията на обекта? Какво е неговото предназначение? Синтез на всички данни.",
      rep: "INTELLIGENCE ДОКЛАД: Резултат от анализа. Валиден при >50% signal strength."
    },
    matrix: ["СЕТИВНИ (S)", "РАЗМЕРИ (D)", "AOL (ШУМ)"],
    stages: ["Идеограм", "Сетивни", "Скица", "Матрица", "Обобщение"],
    repLabels: {
      taskId: "TASK ID",
      status: "СТАТУС",
      gestalt: "ВИЗУАЛЕН ГЕЩАЛТ",
      sensory: "СЕТИВНИ ДАННИ",
      sketch: "СКИЦА",
      profile: "ПРОФИЛ",
      signal: "СИГНАЛ",
      noise: "ШУМ",
      conclusion: "ЗАКЛЮЧЕНИЕ",
      end: "КРАЙ НА ТРАНСМИСИЯ"
    }
  },
  en: {
    protocol: "PROTOCOL", signal: "SIGNAL STRENGTH", noise: "ANALYTIC NOISE", 
    minreq: "REQ: >50% FOR VALIDITY", coords: "COORDINATES", 
    newbtn: "NEW SESSION", repbtn: "FINALIZE", log: "LIVE LOG", logbtn: "LOG",
    hints: {
      s1: "Stage 1: IDEOGRAM – Sketch impulse immediately. Describe physical gestalt without analysis (solid/soft, energy, fluid, organic/artificial).",
      s2: "Stage 2: SENSORY – Sensory qualities (colors, sounds, smells, textures, temperature). NO NAMES! Raw sensory data only.",
      s3: "Stage 3: SKETCH – Draw the object. Work instinctively. Avoid complex details. Just form and space.",
      s4: "Stage 4: MATRIX – Separate data: Sensory (S), Dimensions (D), Analytic Overlay (AOL). Isolate pure signal.",
      s5: "Stage 5: SUMMARY – Interrogation. What is the object's function? What is its purpose? Synthesize all data.",
      rep: "INTELLIGENCE REPORT: Analysis result. Valid at >50% signal strength."
    },
    matrix: ["SENSORY (S)", "DIMENSIONS (D)", "AOL (NOISE)"],
    stages: ["Ideogram", "Sensory", "Sketch", "Matrix", "Summary"],
    repLabels: {
      taskId: "TASK ID",
      status: "STATUS",
      gestalt: "VISUAL GESTALT",
      sensory: "SENSORY DATA",
      sketch: "SKETCH",
      profile: "PROFILE",
      signal: "SIGNAL",
      noise: "NOISE",
      conclusion: "CONCLUSION",
      end: "END OF TRANSMISSION"
    }
  },
  de: {
    protocol: "PROTOKOLL", signal: "SIGNALSTÄRKE", noise: "ANALYTISCHES RAUSCHEN",
    minreq: "MIN: >50% FÜR GÜLTIGKEIT", coords: "KOORDINATEN",
    newbtn: "NEUE SITZUNG", repbtn: "ABSCHLIESSEN", log: "LIVE-PROTOKOLL", logbtn: "LOG",
    hints: {
      s1: "Stufe 1: IDEOGRAM – Skizzieren Sie den Impuls sofort. Beschreiben Sie physische Gestalt ohne Analyse (fest/weich, Energie, Flüssigkeit, organisch/künstlich).",
      s2: "Stufe 2: SENSORY – Sensorische Qualitäten (Farben, Geräusche, Gerüche, Texturen, Temperatur). KEINE NAMEN! Nur rohe sensorische Daten.",
      s3: "Stufe 3: SKETCH – Zeichnen Sie das Objekt. Arbeiten Sie instinktiv. Vermeiden Sie komplexe Details. Nur Form und Raum.",
      s4: "Stufe 4: MATRIX – Trennen Sie Daten: Sensorisch (S), Dimensionen (D), Analytische Überlagerung (AOL). Isolieren Sie reines Signal.",
      s5: "Stufe 5: SUMMARY – Verhör. Was ist die Funktion des Objekts? Was ist sein Zweck? Synthetisieren Sie alle Daten.",
      rep: "GEHEIMDIENSTBERICHT: Analyseergebnis. Gültig bei >50% Signalstärke."
    },
    matrix: ["SENSORISCH (S)", "DIMENSIONEN (D)", "AOL (RAUSCHEN)"],
    stages: ["Ideogramm", "Sensorisch", "Skizze", "Matrix", "Zusammenfassung"],
    repLabels: {
      taskId: "AUFGABEN-ID",
      status: "STATUS",
      gestalt: "VISUELLE GESTALT",
      sensory: "SENSORISCHE DATEN",
      sketch: "SKIZZE",
      profile: "PROFIL",
      signal: "SIGNAL",
      noise: "RAUSCHEN",
      conclusion: "SCHLUSSFOLGERUNG",
      end: "ENDE DER ÜBERTRAGUNG"
    }
  },
  es: {
    protocol: "PROTOCOLO", signal: "FUERZA DE SEÑAL", noise: "RUIDO ANALÍTICO",
    minreq: "REQ: >50% PARA VALIDEZ", coords: "COORDENADAS",
    newbtn: "NUEVA SESIÓN", repbtn: "FINALIZAR", log: "REGISTRO EN VIVO", logbtn: "LOG",
    hints: {
      s1: "Etapa 1: IDEOGRAM – Dibuja el impulso inmediatamente. Describe la gestalt física sin análisis (sólido/suave, energía, fluido, orgánico/artificial).",
      s2: "Etapa 2: SENSORY – Cualidades sensoriales (colores, sonidos, olores, texturas, temperatura). ¡SIN NOMBRES! Solo datos sensoriales.",
      s3: "Etapa 3: SKETCH – Dibuja el objeto. Trabaja instintivamente. Evita detalles complejos. Solo forma y espacio.",
      s4: "Etapa 4: MATRIX – Separa datos: Sensoriales (S), Dimensiones (D), Superposición Analítica (AOL). Aísla señal pura.",
      s5: "Etapa 5: SUMMARY – Interrogación. ¿Cuál es la función del objeto? ¿Cuál es su propósito? Sintetiza todos los datos.",
      rep: "INFORME DE INTELIGENCIA: Resultado del análisis. Válido con >50% de fuerza de señal."
    },
    matrix: ["SENSORIAL (S)", "DIMENSIONES (D)", "AOL (RUIDO)"],
    stages: ["Ideograma", "Sensorial", "Boceto", "Matriz", "Resumen"],
    repLabels: {
      taskId: "ID DE TAREA",
      status: "ESTADO",
      gestalt: "GESTALT VISUAL",
      sensory: "DATOS SENSORIALES",
      sketch: "BOCETO",
      profile: "PERFIL",
      signal: "SEÑAL",
      noise: "RUIDO",
      conclusion: "CONCLUSIÓN",
      end: "FIN DE TRANSMISIÓN"
    }
  },
  fr: {
    protocol: "PROTOCOLE", signal: "FORCE DU SIGNAL", noise: "BRUIT ANALYTIQUE",
    minreq: "MIN: >50% POUR VALIDITÉ", coords: "COORDONNÉES",
    newbtn: "NOUVELLE SESSION", repbtn: "FINALISER", log: "JOURNAL EN DIRECT", logbtn: "LOG",
    hints: {
      s1: "Étape 1: IDEOGRAM – Dessinez l'impulsion immédiatement. Décrivez la gestalt physique sans analyse (solide/mou, énergie, fluide, organique/artificiel).",
      s2: "Étape 2: SENSORY – Qualités sensorielles (couleurs, sons, odeurs, textures, température). PAS DE NOMS! Données sensorielles brutes uniquement.",
      s3: "Étape 3: SKETCH – Dessinez l'objet. Travaillez instinctivement. Évitez les détails complexes. Juste forme et espace.",
      s4: "Étape 4: MATRIX – Séparez les données: Sensorielles (S), Dimensions (D), Superposition Analytique (AOL). Isolez le signal pur.",
      s5: "Étape 5: SUMMARY – Interrogation. Quelle est la fonction de l'objet? Quel est son but? Synthétisez toutes les données.",
      rep: "RAPPORT DE RENSEIGNEMENT: Résultat de l'analyse. Valide à >50% de force du signal."
    },
    matrix: ["SENSORIEL (S)", "DIMENSIONS (D)", "AOL (BRUIT)"],
    stages: ["Idéogramme", "Sensoriel", "Esquisse", "Matrice", "Résumé"],
    repLabels: {
      taskId: "ID DE TÂCHE",
      status: "STATUT",
      gestalt: "GESTALT VISUELLE",
      sensory: "DONNÉES SENSORIELLES",
      sketch: "ESQUISSE",
      profile: "PROFIL",
      signal: "SIGNAL",
      noise: "BRUIT",
      conclusion: "CONCLUSION",
      end: "FIN DE TRANSMISSION"
    }
  },
  cz: {
    protocol: "PROTOKOL", signal: "SÍLA SIGNÁLU", noise: "ANALYTICKÝ ŠUM",
    minreq: "MIN: >50% PRO VALIDITU", coords: "SOUŘADNICE",
    newbtn: "NOVÁ RELACE", repbtn: "FINALIZOVAT", log: "ŽIVÝ PROTOKOL", logbtn: "LOG",
    hints: {
      s1: "Fáze 1: IDEOGRAM – Okamžitě nakreslete impuls. Popište fyzickou gestalt bez analýzy (pevný/měkký, energie, tekutina, organický/umělý).",
      s2: "Fáze 2: SENSORY – Smyslové vlastnosti (barvy, zvuky, pachy, textury, teplota). ŽÁDNÁ JMÉNA! Pouze surová smyslová data.",
      s3: "Fáze 3: SKETCH – Nakreslete objekt. Pracujte instinktivně. Vyhněte se složitým detailům. Pouze tvar a prostor.",
      s4: "Fáze 4: MATRIX – Oddělte data: Smyslové (S), Rozměry (D), Analytické překrytí (AOL). Izolujte čistý signál.",
      s5: "Fáze 5: SUMMARY – Výslech. Jaká je funkce objektu? Jaký je jeho účel? Syntetizujte všechna data.",
      rep: "ZPRAVODAJSKÁ ZPRÁVA: Výsledek analýzy. Platný při >50% síle signálu."
    },
    matrix: ["SMYSLOVÉ (S)", "ROZMĚRY (D)", "AOL (ŠUM)"],
    stages: ["Ideogram", "Smyslové", "Náčrt", "Matice", "Shrnutí"],
    repLabels: {
      taskId: "ID ÚKOLU",
      status: "STAV",
      gestalt: "VIZUÁLNÍ GESTALT",
      sensory: "SMYSLOVÁ DATA",
      sketch: "NÁČRT",
      profile: "PROFIL",
      signal: "SIGNÁL",
      noise: "ŠUM",
      conclusion: "ZÁVĚR",
      end: "KONEC PŘENOSU"
    }
  }
};

// Enhanced dictionary with more keywords
const DICT = {
  art: [
    'метал', 'пластмаса', 'бетон', 'стъкло', 'права', 'ъгъл', 'квадрат', 'машина', 'сграда', 'път', 'улица',
    'metal', 'concrete', 'structure', 'building', 'glass', 'plastic', 'steel', 'iron', 'road', 'street', 'machine',
    'kov', 'beton', 'budova', 'sklo', 'plast', 'ocel',
    'Metall', 'Beton', 'Gebäude', 'Glas', 'Kunststoff', 'Stahl',
    'acero', 'cristal', 'edificio', 'máquina', 'calle',
    'métal', 'béton', 'bâtiment', 'verre', 'plastique', 'acier'
  ],
  nat: [
    'вода', 'дърво', 'пръст', 'камък', 'планина', 'зелено', 'река', 'пясък', 'небе', 'облак', 'листо',
    'water', 'nature', 'tree', 'rock', 'mountain', 'green', 'river', 'sand', 'sky', 'cloud', 'leaf', 'earth',
    'voda', 'strom', 'příroda', 'hora', 'řeka', 'písek',
    'Wasser', 'Baum', 'Natur', 'Berg', 'Fluss', 'Sand',
    'agua', 'árbol', 'naturaleza', 'montaña', 'río', 'arena',
    'eau', 'arbre', 'nature', 'montagne', 'rivière', 'sable'
  ]
};

// --- APP STATE ---
let state = {
  lang: 'bg',
  stage: 'none',
  trn: '0000/0000',
  data: { gestalt: '', s2: '', s3: '', s4s: '', s4d: '', s4aol: '', s5: '' },
  completedStages: new Set()
};

function changeLanguage() {
  state.lang = document.getElementById('lang-select').value;
  translateUI();
  if(state.stage !== 'none') nav(state.stage);
}

function translateUI() {
  const t = UI_TEXT[state.lang];
  document.getElementById('txt-protocol').textContent = t.protocol;
  document.getElementById('txt-signal').textContent = t.signal;
  document.getElementById('txt-noise').textContent = t.noise;
  document.getElementById('txt-min-req').textContent = t.minreq;
  document.getElementById('txt-coords').textContent = t.coords;
  document.getElementById('txt-new-btn').textContent = t.newbtn;
  document.getElementById('txt-rep-btn').textContent = t.repbtn;
  document.getElementById('txt-log').textContent = t.log;
  document.getElementById('txt-log-btn').textContent = t.logbtn;
}

function initNewSession() {
  // FULL RESET
  state.trn = `${Math.floor(1000+Math.random()*8999)}/${Math.floor(1000+Math.random()*8999)}`;
  state.data = { gestalt: '', s2: '', s3: '', s4s: '', s4d: '', s4aol: '', s5: '' };
  state.stage = 'none';
  state.completedStages = new Set();
  
  document.getElementById('trn-display').textContent = state.trn;
  document.getElementById('sig-fill').style.width = '0%';
  document.getElementById('aol-fill').style.width = '0%';
  document.getElementById('profile-match').textContent = "DATA: WAITING...";
  
  updateProgress();
  log(`SESSION INITIALIZED. TRN: ${state.trn}`);
  nav('s1');
}

function updateProgress() {
  const stages = ['s1', 's2', 's3', 's4', 's5'];
  stages.forEach(s => {
    const el = document.getElementById('prog-' + s);
    if(state.completedStages.has(s)) {
      el.classList.add('completed');
    } else {
      el.classList.remove('completed');
    }
  });
}

function analyze() {
  const all = (state.data.s2 + ' ' + state.data.s3 + ' ' + state.data.s4s + ' ' + state.data.s4d).toLowerCase();
  let aCount = 0, nCount = 0;
  
  DICT.art.forEach(w => { if(all.includes(w.toLowerCase())) aCount++; });
  DICT.nat.forEach(w => { if(all.includes(w.toLowerCase())) nCount++; });

  const totalWords = all.split(/\s+/).filter(w => w.length > 2).length;
  const signal = Math.min((totalWords * 6) + (aCount + nCount) * 4, 100);
  const aol = Math.min(state.data.s4aol.length * 1.5, 100);

  document.getElementById('sig-fill').style.width = signal + '%';
  document.getElementById('aol-fill').style.width = aol + '%';

  let profile = "UNKNOWN";
  if(signal > 20) {
    profile = aCount > nCount ? "ARTIFICIAL STRUCTURE" : "NATURAL ENVIRONMENT";
    if(Math.abs(aCount - nCount) < 2) profile = "COMPLEX / MIXED SITE";
  }
  document.getElementById('profile-match').textContent = `PROFILE: ${profile}`;
}

function nav(s) {
  state.stage = s;
  const ws = document.getElementById('workspace');
  const t = UI_TEXT[state.lang];
  
  // Mark previous stages as completed
  if(['s1','s2','s3','s4','s5'].includes(s)) {
    const stageNum = parseInt(s.substring(1));
    for(let i = 1; i < stageNum; i++) {
      state.completedStages.add('s' + i);
    }
    updateProgress();
  }
  
  ws.innerHTML = '';
  
  if(t.hints[s]) {
    ws.innerHTML += `<div class="hint-text">${t.hints[s]}</div>`;
  }
  
  document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
  if(document.getElementById('b-'+s)) document.getElementById('b-'+s).classList.add('active');

  switch(s) {
    case 's1':
      ws.innerHTML += `<span class="label">GESTALT IMPULSE</span><textarea oninput="state.data.gestalt=this.value; analyze()" placeholder="твърдо, меко, енергия, течност...">${state.data.gestalt}</textarea>`;
      break;
    case 's2':
      ws.innerHTML += `<span class="label">SENSORY DATA</span><textarea style="min-height:200px" oninput="state.data.s2=this.value; analyze()" placeholder="цветове, звуци, мирозми, температура...">${state.data.s2}</textarea>`;
      break;
    case 's3':
      ws.innerHTML += `<span class="label">SKETCH / ВИЗУАЛНО</span><textarea style="min-height:150px" oninput="state.data.s3=this.value; analyze()" placeholder="опиши форма, разположение, пропорции...">${state.data.s3}</textarea>`;
      break;
    case 's4':
      ws.innerHTML += `<div class="matrix-grid">
        <div><span class="label">${t.matrix[0]}</span><textarea oninput="state.data.s4s=this.value; analyze()" placeholder="сетивни данни...">${state.data.s4s}</textarea></div>
        <div><span class="label">${t.matrix[1]}</span><textarea oninput="state.data.s4d=this.value; analyze()" placeholder="размери, скала...">${state.data.s4d}</textarea></div>
        <div style="grid-column: span ${window.innerWidth < 600 ? '1' : '2'}"><span class="label" style="color:var(--amber)">${t.matrix[2]}</span><textarea oninput="state.data.s4aol=this.value; analyze()" placeholder="аналитичен шум, предположения...">${state.data.s4aol}</textarea></div>
      </div>`;
      break;
    case 's5':
      ws.innerHTML += `<span class="label">SUMMARY / ЗАКЛЮЧЕНИЕ</span><textarea style="min-height:200px" oninput="state.data.s5=this.value" placeholder="функция на обекта, предназначение, интерпретация...">${state.data.s5}</textarea>`;
      state.completedStages.add('s5');
      updateProgress();
      break;
    case 'rep':
      showReport(); break;
  }
  analyze();
}

function showReport() {
  const sig = parseInt(document.getElementById('sig-fill').style.width);
  const t = UI_TEXT[state.lang];
  const labels = t.repLabels;
  const status = sig > 50 ? "✓ VALID INTEL" : "⚠ SPECULATIVE / LOW SIGNAL";
  
  const report = `
╔════════════════════════════════════════════════╗
║    AIRV STRATEGIC INTELLIGENCE REPORT         ║
╚════════════════════════════════════════════════╝

${labels.taskId}: ${state.trn}
${labels.status}: ${status}

─────────────────────────────────────────────────

1. ${labels.gestalt}:
${state.data.gestalt || 'N/A'}

2. ${labels.sensory}:
${state.data.s2 || 'NO DATA'}

3. ${labels.sketch}:
${state.data.s3 || 'NO SKETCH'}

4. ${labels.profile}:
${document.getElementById('profile-match').textContent}

5. ${labels.signal}: ${sig}%
   ${labels.noise}: ${document.getElementById('aol-fill').style.width}

6. ${labels.conclusion}:
${state.data.s5 || 'NO SUMMARY PROVIDED'}

─────────────────────────────────────────────────
MATRIX DATA:
• Sensory: ${state.data.s4s || 'N/A'}
• Dimensions: ${state.data.s4d || 'N/A'}
• AOL: ${state.data.s4aol || 'N/A'}

─────────────────────────────────────────────────
${labels.end}
╚════════════════════════════════════════════════╝
  `;
  document.getElementById('workspace').innerHTML = `<div class="report-frame">${report}</div>`;
  
  state.completedStages.add('rep');
  updateProgress();
}

function toggleLog() {
  const panel = document.getElementById('log-panel');
  panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
}

function log(m) {
  const l = document.getElementById('log-content');
  const time = new Date().toLocaleTimeString('en-GB');
  l.innerHTML = `<div>[${time}] > ${m}</div>` + l.innerHTML;
}

// Show log button on mobile
if(window.innerWidth < 1200) {
  document.getElementById('txt-log-btn').style.display = 'block';
}

window.addEventListener('resize', () => {
  if(window.innerWidth < 1200) {
    document.getElementById('txt-log-btn').style.display = 'block';
  } else {
    document.getElementById('txt-log-btn').style.display = 'none';
    document.getElementById('log-panel').style.display = 'flex';
  }
});

setInterval(() => { 
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-GB'); 
}, 1000);

window.onload = () => { 
  translateUI(); 
  log("AIRV SYSTEM ONLINE.");
  log("AWAITING SESSION INITIALIZATION...");
};
</script>
</body>
</html>
